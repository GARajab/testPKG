<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS4 Store Installation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            text-align: center;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #00a8ff;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .status {
            background: rgba(0, 168, 255, 0.1);
            border: 2px solid #00a8ff;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
        }

        .btn {
            background: #00a8ff;
            color: black;
            padding: 20px 40px;
            border: none;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
            width: 100%;
        }

        .btn:hover {
            background: #0097e6;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .log {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
            font-family: monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 3px 0;
            padding: 3px;
        }

        .log-success {
            color: #00ff00;
        }

        .log-error {
            color: #ff0000;
        }

        .log-info {
            color: #00a8ff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸŽ® Installing Store.pkg</h1>

        <div class="status" id="status">
            <p id="statusText">Ready to install</p>
            <div class="log" id="log"></div>
        </div>

        <button class="btn" onclick="startInstall()" id="installBtn">
            ðŸš€ Start Installation
        </button>

        <p style="margin-top: 20px; opacity: 0.7; font-size: 14px;">
            If installation doesn't start, click the button above.
        </p>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const PKG_URL = params.get('pkg') || 'https://github.com/GARajab/testPKG/blob/main/Store.pkg';
        const PKG_NAME = params.get('name') || 'Store.pkg';

        const logDiv = document.getElementById('log');
        const installBtn = document.getElementById('installBtn');
        const statusText = document.getElementById('statusText');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function startInstall() {
            installBtn.disabled = true;
            installBtn.textContent = 'Installing...';
            statusText.textContent = 'Starting installation...';

            log('Starting Store.pkg installation...', 'info');

            // For GitHub blob URLs, we need to use the raw download link
            let downloadUrl = PKG_URL;
            if (PKG_URL.includes('github.com') && PKG_URL.includes('/blob/')) {
                // Convert GitHub blob URL to raw download URL
                downloadUrl = PKG_URL
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                log(`Converted to raw URL: ${downloadUrl}`, 'info');
            }

            // Try multiple installation methods
            const methods = [
                { name: 'Direct Download', func: () => directDownload(downloadUrl) },
                { name: 'Alternative Method', func: () => alternativeDownload(PKG_URL) },
                { name: 'GitHub Raw', func: () => githubRawDownload(PKG_URL) }
            ];

            executeInstallMethods(methods, 0);
        }

        function executeInstallMethods(methods, index) {
            if (index >= methods.length) {
                log('All methods attempted.', 'info');
                statusText.textContent = 'Installation attempted. Check PS4 downloads.';
                installBtn.textContent = 'Retry Installation';
                installBtn.disabled = false;
                return;
            }

            const method = methods[index];
            log(`Trying ${method.name}...`, 'info');

            method.func()
                .then(success => {
                    if (success) {
                        log(`${method.name} succeeded!`, 'success');
                        statusText.textContent = 'Installation started! Check PS4 notifications.';
                        installBtn.textContent = 'Installation Started';
                        return;
                    } else {
                        log(`${method.name} failed`, 'error');
                        executeInstallMethods(methods, index + 1);
                    }
                })
                .catch(error => {
                    log(`${method.name} error: ${error.message}`, 'error');
                    executeInstallMethods(methods, index + 1);
                });
        }

        function directDownload(url) {
            return new Promise((resolve) => {
                try {
                    log('Creating direct download link...', 'info');
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = PKG_NAME;
                    link.style.display = 'none';
                    document.body.appendChild(link);

                    // Try to trigger download
                    setTimeout(() => link.click(), 100);
                    setTimeout(() => link.click(), 500);

                    setTimeout(() => {
                        document.body.removeChild(link);
                        log('Direct download triggered', 'success');
                        resolve(true);
                    }, 1000);
                } catch (error) {
                    log(`Direct download failed: ${error.message}`, 'error');
                    resolve(false);
                }
            });
        }

        function alternativeDownload(originalUrl) {
            return new Promise((resolve) => {
                try {
                    log('Trying alternative GitHub download...', 'info');

                    // Method 1: Try with ?raw=true parameter
                    const urlWithRaw = originalUrl + '?raw=true';
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = urlWithRaw;
                    document.body.appendChild(iframe);

                    // Method 2: Try window.open
                    setTimeout(() => {
                        try {
                            window.open(urlWithRaw, '_blank');
                        } catch (e) {
                            // Ignore popup blocker
                        }
                    }, 500);

                    setTimeout(() => {
                        if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                        }
                        log('Alternative methods attempted', 'info');
                        resolve(true);
                    }, 1500);
                } catch (error) {
                    log(`Alternative download failed: ${error.message}`, 'error');
                    resolve(false);
                }
            });
        }

        function githubRawDownload(githubUrl) {
            return new Promise((resolve) => {
                try {
                    log('Converting to GitHub raw URL...', 'info');

                    // Convert GitHub URL to raw URL
                    let rawUrl = githubUrl;
                    if (githubUrl.includes('github.com') && githubUrl.includes('/blob/')) {
                        rawUrl = githubUrl
                            .replace('github.com', 'raw.githubusercontent.com')
                            .replace('/blob/', '/');
                    }

                    log(`Using raw URL: ${rawUrl}`, 'info');

                    // Create multiple download attempts
                    const link = document.createElement('a');
                    link.href = rawUrl;
                    link.download = PKG_NAME;
                    link.style.display = 'none';
                    document.body.appendChild(link);

                    // Try multiple times
                    const attempts = [100, 300, 600, 1000];
                    attempts.forEach(delay => {
                        setTimeout(() => {
                            try {
                                link.click();
                            } catch (e) {
                                // Ignore errors
                            }
                        }, delay);
                    });

                    setTimeout(() => {
                        document.body.removeChild(link);
                        log('GitHub raw download attempted', 'success');
                        resolve(true);
                    }, 1500);
                } catch (error) {
                    log(`GitHub raw download failed: ${error.message}`, 'error');
                    resolve(false);
                }
            });
        }

        // Auto-start if on PS4
        const isPS4 = /PlayStation|PS4/i.test(navigator.userAgent);
        if (isPS4) {
            log('PS4 browser detected! Auto-starting in 3 seconds...', 'success');
            setTimeout(() => {
                startInstall();
            }, 3000);
        }

        // Auto-start after 5 seconds on any device
        setTimeout(() => {
            if (installBtn.disabled === false) {
                log('Auto-starting installation...', 'info');
                startInstall();
            }
        }, 5000);
    </script>
</body>

</html>